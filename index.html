<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi Timer & Stopwatch Pro</title>
<style>
    :root {
        --bg: #121212;
        --card: #1e1e1e;
        --text: #ffffff;
        --timer-color: #3498db;
        --stopwatch-color: #9b59b6;
        --danger: #e74c3c;
        --success: #2ecc71;
    }

    body {
        font-family: 'Segoe UI', sans-serif;
        background: var(--bg);
        color: var(--text);
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
    }

    h1 { color: #888; font-size: 1.5rem; margin-bottom: 20px; }

    /* --- BUTTONS --- */
    button {
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        transition: 0.2s;
    }
    button:active { transform: scale(0.95); }
    .btn-timer { background: var(--timer-color); }
    .btn-sw { background: var(--stopwatch-color); }
    .btn-danger { background: var(--danger); }
    .btn-success { background: var(--success); }
    .btn-control { width: 40px; height: 40px; font-size: 1.2rem; padding: 0; }

    #main-menu {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }

    /* --- INPUT PANELS --- */
    .control-panel {
        display: none; /* Hidden by default */
        background: #252525;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #444;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        justify-content: center;
    }
    input {
        padding: 10px;
        background: #333;
        border: 1px solid #555;
        color: white;
        border-radius: 5px;
        text-align: center;
    }
    .input-name { width: 150px; text-align: left; }
    .input-time { width: 50px; }

    /* --- GRID --- */
    #container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        width: 100%;
        max-width: 1200px;
    }

    /* --- CARDS --- */
    .card {
        background: var(--card);
        border: 1px solid #333;
        border-radius: 15px;
        padding: 20px;
        width: 280px;
        text-align: center;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    .card.timer-mode { border-top: 4px solid var(--timer-color); }
    .card.sw-mode { border-top: 4px solid var(--stopwatch-color); }

    .card-title { color: #aaa; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;}
    .time-display { font-size: 3rem; font-weight: 700; font-variant-numeric: tabular-nums; margin: 10px 0; }
    .money-display { color: #f1c40f; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; }
    
    .card-controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
    }

    .badge {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 0.7rem;
        padding: 3px 6px;
        border-radius: 4px;
        background: #333;
    }
    .running .badge { background: var(--success); color: #000; }

    #role-indicator {
        margin-top: auto;
        padding: 30px;
        color: #555;
        font-size: 0.8rem;
    }
</style>
</head>
<body>

    <h1>DASHBOARD TIMER & STOPWATCH</h1>

    <div id="main-menu">
        <button class="btn-timer" onclick="togglePanel('timer')">+ Buat Timer</button>
        <button class="btn-sw" onclick="togglePanel('stopwatch')">+ Buat Stopwatch</button>
        <button class="btn-danger" onclick="deleteAll()">Hapus Semua</button>
    </div>

    <div id="panel-timer" class="control-panel">
        <input id="timerName" class="input-name" placeholder="Nama (Cth: Masak)">
        <div style="display:flex; align-items:center; gap:5px;">
            <input id="timerHours" class="input-time" type="number" min="0" placeholder="Jam"> :
            <input id="timerMinutes" class="input-time" type="number" min="0" placeholder="Mnt">
        </div>
        <button class="btn-success" onclick="addTimer()">TAMBAH</button>
    </div>

    <div id="panel-stopwatch" class="control-panel">
        <input id="swName" class="input-name" placeholder="Nama (Cth: Lembur)">
        <button class="btn-success" onclick="addStopwatch()">TAMBAH</button>
    </div>

    <div id="container"></div>

    <div id="role-indicator">MODE: VIEWER</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, set, remove, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // --- CONFIG FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyCb9y-NzS2coR8UFlWE6Nb3r27baCS1mz4",
        authDomain: "timer-89517.firebaseapp.com",
        databaseURL: "https://timer-89517-default-rtdb.firebaseio.com",
        projectId: "timer-89517"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    
    // Referensi Database
    const timersRef = ref(db, "v2/timers");
    const stopwatchRef = ref(db, "v2/stopwatches");

    let timersData = {};
    let stopwatchData = {};
    let isAdmin = false;

    // --- CEK ADMIN ---
    const urlParams = new URLSearchParams(location.search);
    if (urlParams.get("role") === "admin") {
        const pwd = prompt("PASSWORD ADMIN:");
        if (pwd === "redmimahal") {
            isAdmin = true;
            document.getElementById("role-indicator").innerText = "MODE: ADMIN (MASTER)";
            document.getElementById("role-indicator").style.color = "#e74c3c";
        } else {
            alert("Password Salah");
        }
    }

    // --- LISTENER DATA ---
    onValue(timersRef, (snap) => {
        timersData = snap.val() || {};
        renderAll();
    });
    onValue(stopwatchRef, (snap) => {
        stopwatchData = snap.val() || {};
        renderAll();
    });

    // --- RENDER FUNCTION ---
    function renderAll() {
        const container = document.getElementById("container");
        container.innerHTML = "";

        // Render Timers
        Object.keys(timersData).forEach(key => {
            const t = timersData[key];
            const h = String(Math.floor(t.timeLeft / 3600)).padStart(2,"0");
            const m = String(Math.floor((t.timeLeft % 3600) / 60)).padStart(2,"0");
            const s = String(t.timeLeft % 60).padStart(2,"0");

            const controls = isAdmin ? `
                <div class="card-controls">
                    <button class="btn-control ${t.isRunning?'btn-danger':'btn-success'}" 
                        onclick="window.toggleTimer('${key}', ${!t.isRunning})">
                        ${t.isRunning ? '‚è∏' : '‚ñ∂'}
                    </button>
                    <button class="btn-control btn-timer" onclick="window.resetTimer('${key}', ${t.initialTime})">‚Ü∫</button>
                    <button class="btn-control btn-danger" onclick="window.deleteItem('timers', '${key}')">‚úñ</button>
                </div>
            ` : '';

            container.innerHTML += `
                <div class="card timer-mode ${t.isRunning?'running':''}">
                    <div class="badge">${t.isRunning?'JALAN':'PAUSE'}</div>
                    <div class="card-title">${t.name}</div>
                    <div class="time-display">${h}:${m}:${s}</div>
                    ${controls}
                </div>
            `;
        });

        // Render Stopwatches
        Object.keys(stopwatchData).forEach(key => {
            const sw = stopwatchData[key];
            // Format waktu stopwatch: HH:MM:SS
            const h = String(Math.floor(sw.seconds / 3600)).padStart(2,"0");
            const m = String(Math.floor((sw.seconds % 3600) / 60)).padStart(2,"0");
            const s = String(sw.seconds % 60).padStart(2,"0");

            const controls = isAdmin ? `
                <div class="card-controls">
                    <button class="btn-control ${sw.isRunning?'btn-danger':'btn-success'}" 
                        onclick="window.toggleStopwatch('${key}', ${!sw.isRunning})">
                        ${sw.isRunning ? '‚è∏' : '‚ñ∂'}
                    </button>
                    <button class="btn-control btn-danger" onclick="window.resetStopwatch('${key}')">‚Ü∫</button>
                    <button class="btn-control btn-danger" onclick="window.deleteItem('stopwatches', '${key}')">‚úñ</button>
                </div>
            ` : '';

            container.innerHTML += `
                <div class="card sw-mode ${sw.isRunning?'running':''}">
                    <div class="badge">${sw.isRunning?'JALAN':'PAUSE'}</div>
                    <div class="card-title">${sw.name}</div>
                    <div class="time-display">${h}:${m}:${s}</div>
                    <div class="money-display">üí∞ Rp ${sw.money.toLocaleString()}</div>
                    ${controls}
                </div>
            `;
        });
    }

    // --- LOGIC INTERVAL (ADMIN ONLY) ---
    if (isAdmin) {
        setInterval(() => {
            const updates = {};
            let hasUpdates = false;

            // Update Timers (Mundur)
            Object.keys(timersData).forEach(key => {
                const t = timersData[key];
                if (t.isRunning && t.timeLeft > 0) {
                    updates[`v2/timers/${key}/timeLeft`] = t.timeLeft - 1;
                    if (t.timeLeft - 1 <= 0) updates[`v2/timers/${key}/isRunning`] = false;
                    hasUpdates = true;
                }
            });

            // Update Stopwatches (Maju + Uang)
            Object.keys(stopwatchData).forEach(key => {
                const sw = stopwatchData[key];
                if (sw.isRunning) {
                    const nextSec = sw.seconds + 1;
                    updates[`v2/stopwatches/${key}/seconds`] = nextSec;
                    // Tambah uang tiap 60 detik (Rp 100)
                    if (nextSec % 60 === 0) {
                        updates[`v2/stopwatches/${key}/money`] = sw.money + 100;
                    }
                    hasUpdates = true;
                }
            });

            if (hasUpdates) update(ref(db), updates);
        }, 1000);
    }

    // --- UI FUNCTIONS ---
    window.togglePanel = (type) => {
        if(!isAdmin) return alert("Hanya admin!");
        document.querySelectorAll('.control-panel').forEach(el => el.style.display = 'none');
        document.getElementById(`panel-${type}`).style.display = 'flex';
    };

    // --- CRUD ACTIONS ---
    window.addTimer = () => {
        const name = document.getElementById("timerName").value || "Timer";
        const h = parseInt(document.getElementById("timerHours").value) || 0;
        const m = parseInt(document.getElementById("timerMinutes").value) || 0;
        const totalSeconds = (h * 3600) + (m * 60);

        if (totalSeconds <= 0) return alert("Waktu tidak boleh 0");

        push(timersRef, {
            name: name,
            initialTime: totalSeconds,
            timeLeft: totalSeconds,
            isRunning: false
        });
        
        // Clear inputs
        document.getElementById("timerName").value = "";
        document.getElementById("timerHours").value = "";
        document.getElementById("timerMinutes").value = "";
    };

    window.addStopwatch = () => {
        const name = document.getElementById("swName").value || "Stopwatch";
        push(stopwatchRef, {
            name: name,
            seconds: 0,
            money: 0,
            isRunning: false
        });
        document.getElementById("swName").value = "";
    };

    window.deleteItem = (type, key) => {
        if(confirm("Hapus item ini?")) remove(ref(db, `v2/${type}/${key}`));
    };
    
    window.deleteAll = async () => {
        if(!isAdmin) return alert("Akses Ditolak");
        if(confirm("HAPUS SEMUA?")) {
            await set(ref(db, 'v2'), null);
        }
    };

    // --- CONTROL ACTIONS ---
    window.toggleTimer = (key, state) => update(ref(db, `v2/timers/${key}`), {isRunning: state});
    window.resetTimer = (key, init) => update(ref(db, `v2/timers/${key}`), {timeLeft: init, isRunning: false});
    
    window.toggleStopwatch = (key, state) => update(ref(db, `v2/stopwatches/${key}`), {isRunning: state});
    window.resetStopwatch = (key) => update(ref(db, `v2/stopwatches/${key}`), {seconds: 0, money: 0, isRunning: false});

</script>
</body>
</html>
